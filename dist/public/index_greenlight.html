<!DOCTYPE html>
<html>
  <head>
    <title>Sphinx Relay</title>
    <link rel="icon" href="/static/sphinx-logo.png" />
    <style>
      html {
        font-family: Arial, Helvetica, sans-serif;
        color: white;
      }

      body {
        background: #292a2d;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      #qr-wrap {
        background: white;
        width: 300px;
        height: 300px;
        border-radius: 5px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-top: 20px;
      }

      canvas {
        height: 280px;
        width: 280px;
      }

      pre {
        margin-top: 8px;
        border-radius: 10px;
        max-width: 250px;
        padding: 18px 25px 0px 25px;
        border: 1px solid tan;
        background: white;
        overflow: hidden;
        overflow-wrap: break-word;
        display: block;
        white-space: pre-wrap;
        color: darkslategray;
      }

      img {
        height: 100px;
        width: 100px;
        margin-top: 20px;
      }

      p {
        margin-top: 30px;
        max-width: 300px;
        text-align: center;
      }

      ul {
        list-style: none;
        max-width: 333px;
      }

      li {
        margin-top: 8px;
      }

      input[type='checkbox'] {
        pointer-events: none;
      }

      a {
        color: #628aff;
        font-weight: bold;
      }
      a:visited {
        color: #628aff;
        font-weight: bold;
      }
      button {
        margin-top:15px;
        padding:10px 20px;
        cursor: pointer;
      }
      button:hover {
        background-color: #628aff;
        color:white;
      }
      #chanpoint {
        word-break: break-all;
      }
    </style>
  </head>

  <body>
    <img src="/static/sphinx-logo.png" alt="logo" />

    <p id="pp">Scan this QR code with your Sphinx app:</p>
    <div id="qr-wrap">
      <canvas id="qr"></canvas>
    </div>

    <pre id="connection-string">
      CONNECTION_STRING
    </pre>

    <div style="margin-top:10px;">Peer to Sphinx router node:</div>

    <button id="peer">PEER NOW</button>

    <p id="conn">You are connected to a Sphinx Routing Node!</p>
    <p id="pending">You are connected to a Sphinx Routing Node! Opening channel now...</p>
    <p id="chanpoint"></p>

    <script src="/static/js/qrious.js"></script>
    <script>
      ;(function () {
        var qr = new QRious({
          element: document.getElementById('qr'),
          value: 'CONNECTION_STRING',
          size: 300,
        })
      })()
    </script>
    <script>
      function get(id) {
        return document.getElementById(id)
      }
      const qr = get('qr-wrap')
      const string = get('connection-string')
      const pp = get('pp')
      const peer = get('peer')
      const conn = get('conn')
      const pending = get('pending')
      const chanpoint = get('chanpoint')
      pp.style.display = 'none'
      qr.style.display = 'none'
      string.style.display = 'none'
      peer.style.display = 'none'
      conn.style.display = 'none'
      pending.style.display = 'none'
      peer.onclick = async function () {
        console.log('PEER NOW')
        const r = await fetch('/connect_peer', {
          method: 'POST',
        })
        const j = await r.json()
        console.log(j)
      }
      async function startup() {
        const r = await fetch('/peered')
        const j = await r.json()
        console.log(j)
        if(j && j.success && j.response && j.response.peered===false) {
          peer.style.display = 'block'
        }
        if(j && j.success && j.response && j.response.peered && j.response.active===false) {
          pending.style.display = 'block'
        }
        if(j && j.success && j.response && j.response.peered && j.response.active) {
          conn.style.display = 'block'
          qr.style.display = 'flex'
          string.style.display = 'block'
          pp.style.display = 'block'
        }
        if(j && j.success && j.response && j.response.peered && j.response.active===false && j.response.channel_point) {
          chanpoint.innerHTML = 'TXID: ' + j.response.channel_point.split(':')[0]
        }
      }
      startup()
    </script>
  </body>
</html>
